<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Relat√≥rio de Visita Agr√≠cola</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(to bottom,#f5f5f7 0%,#e8e8ea 100%);padding:0;min-height:100vh}
.header-bar{background:linear-gradient(180deg,#2c2c2e 0%,#1c1c1e 100%);color:white;padding:15px 20px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:100;box-shadow:0 2px 10px rgba(0,0,0,.12)}
.header-close{font-size:1.3em;cursor:pointer}
.header-title{font-size:1em;font-weight:500}
.header-save{color:#007AFF;font-weight:600;cursor:pointer;display:flex;gap:15px;align-items:center}
.header-action{cursor:pointer;padding:6px 12px;border-radius:6px;transition:background .2s}
.header-action:hover{background:rgba(0,122,255,.1)}
.container{max-width:800px;margin:0 auto;background:white}
.content{padding:0}
.section{background:white;border-radius:12px;margin:12px 16px;padding:20px;box-shadow:0 1px 3px rgba(0,0,0,.08),0 2px 8px rgba(0,0,0,.04)}
.section-title{font-size:.75em;color:#86868b;text-transform:uppercase;letter-spacing:.5px;margin-bottom:15px;font-weight:500}
.form-group{margin-bottom:0}
.form-row{display:flex;align-items:center;padding:12px 0;border-bottom:1px solid #e5e5e7}
.form-row:last-child{border-bottom:none}
label{flex:0 0 100px;color:#1d1d1f;font-size:1em;font-weight:400}
input[type="text"],input[type="date"],input[type="number"],textarea,select{flex:1;padding:8px 0;border:none;font-size:1em;color:#1d1d1f;background:transparent;text-align:right}
input:focus,textarea:focus,select:focus{outline:none}
textarea{text-align:left;min-height:80px;resize:vertical;padding:12px 0}
.stage-selector select{font-size:1em;cursor:pointer;appearance:none;background:transparent}
.stage-display{display:none;background:linear-gradient(135deg,rgba(255,255,255,.95) 0%,rgba(245,245,247,.98) 100%);backdrop-filter:blur(10px);border-radius:16px;padding:24px;text-align:center;margin:15px 0;border:1px solid rgba(0,0,0,.05);box-shadow:0 4px 16px rgba(0,0,0,.08),0 8px 32px rgba(0,0,0,.04),inset 0 1px 0 rgba(255,255,255,.8)}
.stage-display.active{display:block;animation:slideUp .4s cubic-bezier(.4,0,.2,1)}
@keyframes slideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
.stage-icon-large{font-size:3em;margin-bottom:10px}
.stage-name-large{font-size:1.2em;font-weight:600;color:#1d1d1f;margin-bottom:5px}
.stage-description-large{font-size:.9em;color:#86868b;margin-bottom:10px}
.dap-badge{display:inline-block;background:#007AFF;color:white;padding:6px 14px;border-radius:16px;font-weight:500;font-size:.85em}
.attention-points{background:linear-gradient(135deg,#fff8e1 0%,#fff3cd 100%);border-radius:12px;padding:16px;margin:15px 0 0 0;border:1px solid rgba(255,193,7,.2);box-shadow:0 2px 8px rgba(255,152,0,.08),inset 0 1px 0 rgba(255,255,255,.5)}
.attention-points h3{color:#856404;margin-bottom:12px;font-size:.9em;font-weight:600;display:flex;align-items:center;gap:6px}
.attention-points ul{list-style:none;padding-left:0}
.attention-points li{padding:10px 12px;margin-bottom:6px;font-size:.85em;color:#856404;background:rgba(255,255,255,.7);border-radius:8px;border-left:3px solid #ffc107;box-shadow:0 1px 3px rgba(0,0,0,.05)}
.attention-points li:last-child{margin-bottom:0}
.attention-points li:before{content:"‚Ä¢ ";margin-right:8px}
.category-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:15px;margin:15px 0}
.category-item{display:flex;flex-direction:column;align-items:center;gap:8px;cursor:pointer}
.category-circle{width:65px;height:65px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:2em;transition:all .3s cubic-bezier(.4,0,.2,1);box-shadow:0 2px 8px rgba(0,0,0,.12),0 4px 12px rgba(0,0,0,.08)}
.category-item:active .category-circle{transform:scale(.92);box-shadow:0 1px 4px rgba(0,0,0,.1)}
.category-item.selected .category-circle{box-shadow:0 0 0 3px white,0 0 0 6px #007AFF;transform:scale(1)}
.category-circle.doenca{background:#34C759}
.category-circle.insetos{background:#FF2D55}
.category-circle.ervas{background:#FF9500}
.category-circle.nutrientes{background:#8E8E93}
.category-circle.agua{background:#30B0C7}
.category-circle.outro{background:#5856D6}
.category-name{font-size:.75em;color:#1d1d1f;text-align:center;font-weight:400}
.nutrient-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin:15px 0}
.nutrient-badge{padding:12px 16px;border-radius:10px;text-align:center;cursor:pointer;font-size:.9em;font-weight:600;background:white;color:#1d1d1f;transition:all .3s cubic-bezier(.4,0,.2,1);border:1.5px solid rgba(0,0,0,.08);box-shadow:0 2px 6px rgba(0,0,0,.05);display:flex;flex-direction:column;gap:4px}
.nutrient-badge:active{transform:scale(.96)}
.nutrient-badge.selected{background:linear-gradient(135deg,#FF9500 0%,#FF8000 100%);color:white;border-color:transparent;box-shadow:0 4px 12px rgba(255,149,0,.35)}
.nutrient-badge-icon{font-size:1.2em;font-weight:700}
.nutrient-badge-name{font-size:.75em;font-weight:500}
.problem-header{display:flex;align-items:center;gap:12px;margin-bottom:15px}
.problem-icon-large{font-size:2em}
.problem-title{font-size:1.1em;font-weight:600;color:#1d1d1f}
.severity-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
.severity-option{padding:12px 8px;border-radius:10px;text-align:center;cursor:pointer;font-size:.85em;font-weight:600;background:white;color:#1d1d1f;transition:all .3s cubic-bezier(.4,0,.2,1);border:1.5px solid rgba(0,0,0,.08);box-shadow:0 2px 6px rgba(0,0,0,.05),0 1px 3px rgba(0,0,0,.03)}
.severity-option:active{transform:scale(.96);box-shadow:0 1px 3px rgba(0,0,0,.1)}
.severity-option.selected{transform:scale(.98);border-color:transparent}
.severity-option.nenhum.selected{background:linear-gradient(135deg,#34C759 0%,#2DB04A 100%);color:white;box-shadow:0 4px 12px rgba(52,199,89,.35),0 2px 6px rgba(52,199,89,.25)}
.severity-option.baixa.selected{background:linear-gradient(135deg,#FF9500 0%,#FF8000 100%);color:white;box-shadow:0 4px 12px rgba(255,149,0,.35),0 2px 6px rgba(255,149,0,.25)}
.severity-option.media.selected{background:linear-gradient(135deg,#FF6B00 0%,#FF5500 100%);color:white;box-shadow:0 4px 12px rgba(255,107,0,.35),0 2px 6px rgba(255,107,0,.25)}
.severity-option.alta.selected{background:linear-gradient(135deg,#FF3B30 0%,#E02020 100%);color:white;box-shadow:0 4px 12px rgba(255,59,48,.35),0 2px 6px rgba(255,59,48,.25)}
.add-item{display:flex;align-items:center;gap:15px;padding:15px 0;cursor:pointer;color:#1d1d1f}
.add-item-icon{width:30px;height:30px;display:flex;align-items:center;justify-content:center;font-size:1.5em}
.add-item-text{font-size:1em}
.photos-list{display:flex;flex-direction:column;gap:15px;margin:15px 0 0 0}
.photo-item{background:white;border-radius:16px;overflow:hidden;box-shadow:0 2px 12px rgba(0,0,0,.08),0 4px 24px rgba(0,0,0,.04);border:1px solid rgba(0,0,0,.05)}
.photo-item-header{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;background:linear-gradient(to bottom,#fafafa 0%,#f5f5f7 100%);border-bottom:1px solid rgba(0,0,0,.06)}
.photo-item-type{display:flex;align-items:center;gap:8px;font-weight:600;color:#1d1d1f;font-size:.9em}
.photo-item-remove{background:linear-gradient(135deg,#FF3B30 0%,#E02020 100%);color:white;border:none;border-radius:50%;width:28px;height:28px;font-size:1.1em;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 8px rgba(255,59,48,.3);transition:all .2s}
.photo-item-remove:active{transform:scale(.9)}
.photo-item-image{width:100%;height:200px;object-fit:cover}
.modal{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.4);z-index:1000;align-items:flex-end;justify-content:center}
.modal.active{display:flex}
.modal-content{background:white;border-radius:12px 12px 0 0;width:100%;max-width:800px;max-height:70vh;overflow-y:auto}
.modal-header{padding:20px;border-bottom:1px solid #e5e5e7}
.modal-title{font-size:1.1em;font-weight:600;color:#1d1d1f;margin-bottom:5px}
.modal-subtitle{font-size:.85em;color:#86868b}
.modal-options{padding:10px 0}
.modal-option{display:flex;align-items:center;gap:15px;padding:15px 20px;cursor:pointer;border-bottom:1px solid #e5e5e7}
.modal-option:last-child{border-bottom:none}
.modal-option:active{background:#f5f5f7}
.modal-option-icon{font-size:1.8em}
.modal-option-name{font-size:1em;color:#1d1d1f}
.modal-cancel{padding:15px 20px;text-align:center;color:#007AFF;font-weight:600;cursor:pointer;border-top:1px solid #e5e5e7}
.dap-info{background:#f5f5f7;border-radius:8px;padding:10px 15px;margin-top:10px;text-align:center}
.dap-info strong{color:#007AFF;font-size:.95em}
input[type="file"]{display:none}
.photo-size-selector{margin-top:12px;display:flex;gap:10px;align-items:center}
.photo-size-selector label{font-size:.95em;color:#1d1d1f}
.photo-size-selector select{font-size:1em;border:none;background:transparent;border-bottom:1px solid #ccc;padding:4px 0}
@media (max-width:600px){
  .category-grid{grid-template-columns:repeat(5,1fr);gap:10px}
  .category-circle{width:55px;height:55px;font-size:1.6em}
  .category-name{font-size:.7em}
  .severity-grid{grid-template-columns:repeat(4,1fr);gap:6px}
  .severity-option{padding:10px 6px;font-size:.8em}
}
@media (min-width:768px){
  .container{margin-top:20px;margin-bottom:20px;border-radius:12px;overflow:hidden;box-shadow:0 2px 10px rgba(0,0,0,.1)}
  .modal-content{border-radius:12px;max-height:80vh}
}
@media print{
  .header-bar,.add-item,.photo-item-remove,.remove-tag{display:none}
}
</style>
</head>
<body>
<div class="header-bar">
  <div class="header-close" onclick="window.history.back()">‚úï</div>
  <div class="header-title">Relat√≥rio de Visita</div>
  <div class="header-save">
    <div class="header-action" onclick="exportToPDF()">üìÑ PDF</div>
    <div class="header-action" onclick="window.print()">üñ®Ô∏è Imprimir</div>
  </div>
</div>
<div class="container">
  <div class="content">
    <!-- Se√ß√£o de Informa√ß√µes -->
    <div class="section">
      <div class="section-title">Informa√ß√µes da Visita</div>
      <div class="form-row"><label>Produtor</label><input type="text" id="produtor" placeholder="Nome"></div>
      <div class="form-row"><label>Propriedade</label><input type="text" id="propriedade" placeholder="Nome"></div>
      <div class="form-row"><label>Data</label><input type="date" id="data"></div>
      <div class="form-row"><label>√Årea (ha)</label><input type="number" id="area" placeholder="0.00" step="0.01"></div>
      <div class="form-row"><label>Cultivar</label><input type="text" id="cultivar" placeholder="TMG 7062"></div>
      <div class="form-row"><label>Plantio</label><input type="date" id="plantio" onchange="calculateDAP()"></div>
      <div class="dap-info" id="dapInfo" style="display: none;"><strong>DAP: <span id="dapValue">0</span> dias</strong></div>
    </div>

    <!-- Est√°dio Fenol√≥gico -->
    <div class="section">
      <div class="section-title">Est√°dio Fenol√≥gico</div>
      <div class="form-row">
        <label>Est√°dio</label>
        <select id="stageSelect" onchange="showStageInfo()">
          <option value="">Selecione</option>
          <option value="VE">VE - Emerg√™ncia</option>
          <option value="VC">VC - Cotil√©dones</option>
          <option value="V1">V1 - 1¬™ Trifoliolada</option>
          <option value="V2">V2 - 2¬™ Trifoliolada</option>
          <option value="V3">V3 - 3¬™ Trifoliolada</option>
          <option value="V4">V4 - 4¬™ Trifoliolada</option>
          <option value="V5">V5 - 5¬™ Trifoliolada</option>
          <option value="R1">R1 - Florescimento</option>
          <option value="R2">R2 - Flora√ß√£o Plena</option>
          <option value="R3">R3 - Vagens 1cm</option>
          <option value="R4">R4 - Vagens 2cm</option>
          <option value="R5.1">R5.1 - In√≠cio Enchimento</option>
          <option value="R5.3">R5.3 - 50% Enchimento</option>
          <option value="R5.5">R5.5 - 100% Enchimento</option>
          <option value="R6">R6 - Gr√£os Formados</option>
          <option value="R7">R7 - In√≠cio Matura√ß√£o</option>
          <option value="R8">R8 - Matura√ß√£o Plena</option>
        </select>
      </div>
      <div class="stage-display" id="stageDisplay">
        <div class="stage-icon-large" id="stageIcon"></div>
        <div class="stage-name-large" id="stageName"></div>
        <div class="stage-description-large" id="stageDescription"></div>
        <div class="dap-badge" id="stageDap"></div>
      </div>
      <div class="attention-points" id="attentionPoints" style="display: none;">
        <h3>‚ö†Ô∏è Pontos de Aten√ß√£o</h3>
        <ul id="attentionList"></ul>
      </div>
    </div>

    <!-- Categoria -->
    <div class="section">
      <div class="section-title">Categoria</div>
      <div class="category-grid">
        <div class="category-item" onclick="toggleCategory('doenca')"><div class="category-circle doenca">ü¶†</div><div class="category-name">Doen√ßa</div></div>
        <div class="category-item" onclick="toggleCategory('insetos')"><div class="category-circle insetos">üêõ</div><div class="category-name">Insetos</div></div>
        <div class="category-item" onclick="toggleCategory('ervas')"><div class="category-circle ervas">üåæ</div><div class="category-name">Ervas daninhas</div></div>
        <div class="category-item" onclick="toggleCategory('nutrientes')"><div class="category-circle nutrientes">‚ìÉ</div><div class="category-name">Nutrientes</div></div>
        <div class="category-item" onclick="toggleCategory('agua')"><div class="category-circle agua">üíß</div><div class="category-name">√Ågua</div></div>
      </div>
    </div>

    <div id="problemsContainer"></div>

    <!-- Fotos -->
    <div class="section">
      <div class="section-title">Fotos</div>
      <div class="add-item" onclick="openPhotoCategories()">
        <div class="add-item-icon">üì∑</div>
        <div class="add-item-text">Adicionar Foto</div>
      </div>
      <div class="photo-size-selector">
        <label>Tamanho no PDF:</label>
        <select id="photoSizeSelect">
          <option value="small">Pequena</option>
          <option value="medium" selected>M√©dia</option>
          <option value="large">Grande</option>
        </select>
      </div>
      <div class="photos-list" id="photosList"></div>
    </div>

    <!-- Observa√ß√µes, Recomenda√ß√µes, etc -->
    <div class="section"><div class="section-title">Observa√ß√µes</div><div class="form-row"><textarea id="observacoes" placeholder="Observa√ß√µes gerais sobre a lavoura..."></textarea></div></div>
    <div class="section"><div class="section-title">Recomenda√ß√µes</div><div class="form-row"><textarea id="recomendacoes" placeholder="Recomenda√ß√µes t√©cnicas..."></textarea></div></div>
    <div class="section"><div class="section-title">Respons√°vel</div><div class="form-row"><input type="text" id="tecnico" placeholder="Nome do t√©cnico"></div></div>
    <div class="section">
      <div class="section-title">Localiza√ß√£o</div>
      <div class="form-row"><label>Coordenadas</label><input type="text" id="coordenadas" placeholder="Pin" readonly></div>
      <div style="padding:12px 0;color:#007AFF;cursor:pointer;font-size:.95em;" onclick="getCurrentLocation()">üìç Definir para minha localiza√ß√£o atual</div>
    </div>
    <div class="section">
      <div class="section-title">Tipo de Ocorr√™ncia</div>
      <div style="display:flex;gap:30px;padding:12px 0;">
        <label style="display:flex;align-items:center;gap:10px;cursor:pointer;flex:none;"><input type="radio" name="tipo" value="sazonal" id="sazonal" checked style="width:20px;height:20px;"><span>Sazonal</span></label>
        <label style="display:flex;align-items:center;gap:10px;cursor:pointer;flex:none;"><input type="radio" name="tipo" value="permanente" id="permanente" style="width:20px;height:20px;"><span>Permanente</span></label>
      </div>
    </div>
    <div class="section">
      <div class="section-title">Amostras</div>
      <div style="padding:12px 0;"><label style="display:flex;align-items:center;gap:12px;cursor:pointer;"><input type="checkbox" id="amostraSolo" style="width:22px;height:22px;cursor:pointer;"><span style="font-size:1em;color:#1d1d1f;">Amostra de solo</span></label></div>
    </div>
  </div>
</div>

<!-- Modais -->
<div class="modal" id="photoCategoryModal">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title">Categoria da Foto</div>
      <div class="modal-subtitle">Selecione a categoria</div>
    </div>
    <div class="modal-options">
      <div class="modal-option" onclick="selectPhotoCategory('doenca')"><div class="modal-option-icon">ü¶†</div><div class="modal-option-name">Doen√ßa</div></div>
      <div class="modal-option" onclick="selectPhotoCategory('insetos')"><div class="modal-option-icon">üêõ</div><div class="modal-option-name">Insetos</div></div>
      <div class="modal-option" onclick="selectPhotoCategory('ervas')"><div class="modal-option-icon">üåæ</div><div class="modal-option-name">Ervas Daninhas</div></div>
      <div class="modal-option" onclick="selectPhotoCategory('nutrientes')"><div class="modal-option-icon">‚ìÉ</div><div class="modal-option-name">Nutrientes</div></div>
      <div class="modal-option" onclick="selectPhotoCategory('agua')"><div class="modal-option-icon">üíß</div><div class="modal-option-name">√Ågua</div></div>
      <div class="modal-option" onclick="selectPhotoCategory('geral')"><div class="modal-option-icon">üåæ</div><div class="modal-option-name">Geral da Lavoura</div></div>
    </div>
    <div class="modal-cancel" onclick="closeAllModals()">Cancelar</div>
  </div>
</div>

<div class="modal" id="photoModal">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title">Classificar Foto</div>
      <div class="modal-subtitle">Qual o tipo desta foto?</div>
    </div>
    <div class="modal-options">
      <div class="modal-option" onclick="selectPhotoType('geral')"><div class="modal-option-icon">üåæ</div><div class="modal-option-name">Foto Geral da Lavoura</div></div>
      <div class="modal-option" onclick="selectPhotoType('detalhe')"><div class="modal-option-icon">üîç</div><div class="modal-option-name">Detalhe da Planta</div></div>
      <div class="modal-option" onclick="selectPhotoType('problema')"><div class="modal-option-icon">‚ö†Ô∏è</div><div class="modal-option-name">Problema Identificado</div></div>
    </div>
    <div class="modal-cancel" onclick="closeAllModals()">Cancelar</div>
  </div>
</div>

<input type="file" id="photoInput" accept="image/*" onchange="handlePhoto()">

<!-- Scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
// --- DADOS ---
const stages = {
  "VE": { icon: "üå±", name: "Emerg√™ncia", description: "Primeiras folhas emergem do solo", dapRange: "0-5" },
  "VC": { icon: "üåø", name: "Cotil√©dones", description: "Folhas cotiledonares expandidas", dapRange: "5-8" },
  "V1": { icon: "üåø", name: "1¬™ Trifoliolada", description: "Primeira folha trifoliolada totalmente expandida", dapRange: "8-12" },
  "V2": { icon: "üåø", name: "2¬™ Trifoliolada", description: "Segunda folha trifoliolada expandida", dapRange: "12-16" },
  "V3": { icon: "üåø", name: "3¬™ Trifoliolada", description: "Terceira folha trifoliolada expandida", dapRange: "16-20" },
  "V4": { icon: "üåø", name: "4¬™ Trifoliolada", description: "Quarta folha trifoliolada expandida", dapRange: "20-24" },
  "V5": { icon: "üåø", name: "5¬™ Trifoliolada", description: "Quinta folha trifoliolada expandida", dapRange: "24-28" },
  "R1": { icon: "üåº", name: "Florescimento", description: "Primeiras flores abertas", dapRange: "28-35" },
  "R2": { icon: "üåº", name: "Flora√ß√£o Plena", description: "Pico de flora√ß√£o", dapRange: "35-42" },
  "R3": { icon: "üå±", name: "Vagens 1cm", description: "Vagens com 5mm a 1cm", dapRange: "42-50" },
  "R4": { icon: "üå±", name: "Vagens 2cm", description: "Vagens com 2cm", dapRange: "50-58" },
  "R5.1": { icon: "üå±", name: "In√≠cio Enchimento", description: "Gr√£os come√ßam a se formar", dapRange: "58-65" },
  "R5.3": { icon: "üå±", name: "50% Enchimento", description: "Gr√£os atingem metade do tamanho", dapRange: "65-72" },
  "R5.5": { icon: "üå±", name: "100% Enchimento", description: "Gr√£os atingem tamanho m√°ximo", dapRange: "72-78" },
  "R6": { icon: "üå±", name: "Gr√£os Formados", description: "Gr√£os totalmente formados", dapRange: "78-85" },
  "R7": { icon: "üçÇ", name: "In√≠cio Matura√ß√£o", description: "Primeiras folhas amarelam", dapRange: "85-95" },
  "R8": { icon: "üçÇ", name: "Matura√ß√£o Plena", description: "Plantas senescentes, colheita poss√≠vel", dapRange: "95+" }
};

const categories = {
  "doenca": { icon: "ü¶†", name: "Doen√ßa", nutrients: null },
  "insetos": { icon: "üêõ", name: "Insetos/√Åcaros", nutrients: null },
  "ervas": { icon: "üåæ", name: "Ervas Daninhas", nutrients: null },
  "nutrientes": {
    icon: "‚ìÉ",
    name: "Defici√™ncia Nutricional",
    nutrients: ["N", "P", "K", "Ca", "Mg", "S", "Fe", "Mn", "Zn", "Cu", "B", "Mo"]
  },
  "agua": { icon: "üíß", name: "Problema H√≠drico", nutrients: null }
};

const photoTypes = {
  'geral': { icon: 'üåæ', name: 'Foto Geral' },
  'detalhe': { icon: 'üîç', name: 'Detalhe' },
  'problema': { icon: '‚ö†Ô∏è', name: 'Problema' }
};

// --- STATE ---
let selectedCategories = new Set();
let severityData = {};
let photos = [];
let pendingPhoto = null;
let pendingPhotoCategory = null;
let selectedNutrients = new Set();

// --- UTILS ---
const saveToStorage = () => {
  const data = {
    produtor: document.getElementById('produtor').value,
    propriedade: document.getElementById('propriedade').value,
    data: document.getElementById('data').value,
    area: document.getElementById('area').value,
    cultivar: document.getElementById('cultivar').value,
    plantio: document.getElementById('plantio').value,
    dapValue: document.getElementById('dapValue').textContent,
    stageSelect: document.getElementById('stageSelect').value,
    observacoes: document.getElementById('observacoes').value,
    recomendacoes: document.getElementById('recomendacoes').value,
    tecnico: document.getElementById('tecnico').value,
    coordenadas: document.getElementById('coordenadas').value,
    tipo: document.querySelector('input[name="tipo"]:checked').value,
    amostraSolo: document.getElementById('amostraSolo').checked,
    selectedCategories: Array.from(selectedCategories),
    severityData,
    selectedNutrients: Array.from(selectedNutrients),
    photos,
    photoSize: document.getElementById('photoSizeSelect').value
  };
  localStorage.setItem('relatorio-visita', JSON.stringify(data));
};

const loadFromStorage = () => {
  const saved = localStorage.getItem('relatorio-visita');
  if (!saved) return;

  const data = JSON.parse(saved);
  document.getElementById('produtor').value = data.produtor || '';
  document.getElementById('propriedade').value = data.propriedade || '';
  document.getElementById('data').value = data.data || '';
  document.getElementById('area').value = data.area || '';
  document.getElementById('cultivar').value = data.cultivar || '';
  document.getElementById('plantio').value = data.plantio || '';

  if (data.plantio && data.data) {
    const p = new Date(data.plantio);
    const v = new Date(data.data);
    if (!isNaN(p.getTime()) && !isNaN(v.getTime())) {
      const dap = Math.floor((v - p) / (1000 * 60 * 60 * 24));
      document.getElementById('dapValue').textContent = dap;
      document.getElementById('dapInfo').style.display = 'block';
    }
  }

  document.getElementById('observacoes').value = data.observacoes || '';
  document.getElementById('recomendacoes').value = data.recomendacoes || '';
  document.getElementById('tecnico').value = data.tecnico || '';
  document.getElementById('coordenadas').value = data.coordenadas || '';
  document.getElementById('sazonal').checked = data.tipo === 'sazonal';
  document.getElementById('permanente').checked = data.tipo === 'permanente';
  document.getElementById('amostraSolo').checked = data.amostraSolo || false;

  selectedCategories = new Set(data.selectedCategories || []);
  severityData = data.severityData || {};
  selectedNutrients = new Set(data.selectedNutrients || []);
  photos = data.photos || [];
  document.getElementById('photoSizeSelect').value = data.photoSize || 'medium';

  document.getElementById('stageSelect').value = data.stageSelect || '';
  if (data.stageSelect) showStageInfo();

  // Atualiza UI das categorias
  document.querySelectorAll('.category-item').forEach(el => {
    const id = el.getAttribute('data-id');
    if (id && selectedCategories.has(id)) {
      el.classList.add('selected');
    }
  });

  renderProblems();
  renderPhotos();
};

// Atribui data-id para sele√ß√£o
document.querySelectorAll('.category-item').forEach((el, i) => {
  const ids = ['doenca','insetos','ervas','nutrientes','agua'];
  el.setAttribute('data-id', ids[i]);
});

// --- EVENT LISTENERS ---
document.addEventListener('DOMContentLoaded', function() {
  try {
    document.getElementById('data').valueAsDate = new Date();
    // Tenta obter localiza√ß√£o automaticamente
    getCurrentLocation();
  } catch (error) {
    console.error('Erro ao inicializar:', error);
  }

  // Carregar dados salvos
  loadFromStorage();

  // Auto-salvar em qualquer mudan√ßa
  document.querySelectorAll('input, textarea, select, [type="radio"], [type="checkbox"]').forEach(el => {
    el.addEventListener('input', saveToStorage);
    el.addEventListener('change', saveToStorage);
  });

  // Salvar ao fechar
  window.addEventListener('beforeunload', saveToStorage);
});

// --- FUN√á√ïES PRINCIPAIS ---
function showStageInfo() {
  const stageKey = document.getElementById('stageSelect').value;
  const stageInfo = stages[stageKey];
  const stageDisplay = document.getElementById('stageDisplay');
  if (stageInfo) {
    document.getElementById('stageIcon').textContent = stageInfo.icon;
    document.getElementById('stageName').textContent = stageInfo.name;
    document.getElementById('stageDescription').textContent = stageInfo.description;
    document.getElementById('stageDap').textContent = `DAP: ${stageInfo.dapRange}`;
    stageDisplay.classList.add('active');
  } else {
    stageDisplay.classList.remove('active');
  }
}

function toggleCategory(id) {
  const el = document.querySelector(`.category-item[data-id="${id}"]`);
  if (selectedCategories.has(id)) {
    selectedCategories.delete(id);
    el.classList.remove('selected');
  } else {
    selectedCategories.add(id);
    el.classList.add('selected');
  }
  renderProblems();
  saveToStorage();
}

function renderProblems() {
  const container = document.getElementById('problemsContainer');
  container.innerHTML = '';

  selectedCategories.forEach(catId => {
    const cat = categories[catId];
    if (!cat) return;

    const problemDiv = document.createElement('div');
    problemDiv.className = 'section';
    problemDiv.innerHTML = `
      <div class="problem-header">
        <div class="problem-icon-large">${cat.icon}</div>
        <div class="problem-title">${cat.name}</div>
      </div>
    `;

    if (cat.nutrients) {
      const nutrientGrid = document.createElement('div');
      nutrientGrid.className = 'nutrient-grid';
      cat.nutrients.forEach(nut => {
        const nutrientDiv = document.createElement('div');
        nutrientDiv.className = 'nutrient-badge' + (selectedNutrients.has(nut) ? ' selected' : '');
        nutrientDiv.innerHTML = `<div class="nutrient-badge-icon">${nut}</div><div class="nutrient-badge-name">${nut}</div>`;
        nutrientDiv.onclick = () => toggleNutrient(nut, nutrientDiv);
        nutrientGrid.appendChild(nutrientDiv);
      });
      problemDiv.appendChild(nutrientGrid);
    }

    const severityDiv = document.createElement('div');
    severityDiv.innerHTML = `<div class="section-title">Severidade</div>`;
    const severityGrid = document.createElement('div');
    severityGrid.className = 'severity-grid';
    const levels = [
      { id: 'nenhum', name: 'Nenhum' },
      { id: 'baixa', name: 'Baixa' },
      { id: 'media', name: 'M√©dia' },
      { id: 'alta', name: 'Alta' }
    ];
    levels.forEach(level => {
      const btn = document.createElement('div');
      btn.className = 'severity-option ' + level.id + (severityData[catId] === level.id ? ' selected' : '');
      btn.textContent = level.name;
      btn.onclick = () => selectSeverity(catId, level.id, level.name, btn);
      severityGrid.appendChild(btn);
    });
    severityDiv.appendChild(severityGrid);
    problemDiv.appendChild(severityDiv);

    container.appendChild(problemDiv);
  });
}

function toggleNutrient(nutrientId, el) {
  if (selectedNutrients.has(nutrientId)) {
    selectedNutrients.delete(nutrientId);
    el.classList.remove('selected');
  } else {
    selectedNutrients.add(nutrientId);
    el.classList.add('selected');
  }
  saveToStorage();
}

function selectSeverity(cat, levelId, value, el) {
  // Remover sele√ß√£o anterior
  document.querySelectorAll(`.severity-option`).forEach(btn => {
    if (btn.closest('.section') === el.closest('.section')) {
      btn.classList.remove('selected');
    }
  });
  el.classList.add('selected');
  severityData[cat] = levelId;
  saveToStorage();
}

function openPhotoCategories() {
  document.getElementById('photoCategoryModal').classList.add('active');
}

function selectPhotoCategory(category) {
  pendingPhotoCategory = category;
  document.getElementById('photoCategoryModal').classList.remove('active');
  document.getElementById('photoInput').click();
}

function handlePhoto() {
  const fileInput = document.getElementById('photoInput');
  const file = fileInput.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(e) {
    pendingPhoto = e.target.result;
    document.getElementById('photoModal').classList.add('active');
  };
  reader.readAsDataURL(file);
  fileInput.value = '';
}

function selectPhotoType(type) {
  const typeData = photoTypes[type];
  photos.push({
    id: Date.now(),
    data: pendingPhoto,
    category: pendingPhotoCategory,
    categoryName: categories[pendingPhotoCategory]?.name || 'Geral',
    type: type,
    typeName: typeData.name
  });
  renderPhotos();
  closeAllModals();
  pendingPhoto = null;
  pendingPhotoCategory = null;
  saveToStorage();
}

function closeAllModals() {
  document.getElementById('photoCategoryModal').classList.remove('active');
  document.getElementById('photoModal').classList.remove('active');
  pendingPhoto = null;
  pendingPhotoCategory = null;
}

function renderPhotos() {
  const list = document.getElementById('photosList');
  list.innerHTML = '';
  photos.forEach(photo => {
    const item = document.createElement('div');
    item.className = 'photo-item';
    item.innerHTML = `
      <div class="photo-item-header">
        <div class="photo-item-type">
          ${photo.categoryName} - ${photo.typeName}
        </div>
        <button class="photo-item-remove" onclick="removePhoto(${photo.id})">√ó</button>
      </div>
      <img src="${photo.data}" class="photo-item-image" />
    `;
    list.appendChild(item);
  });
}

function removePhoto(id) {
  photos = photos.filter(p => p.id !== id);
  renderPhotos();
  saveToStorage();
}

function calculateDAP() {
  const plantio = document.getElementById('plantio').value;
  const visita = document.getElementById('data').value;
  if (plantio && visita) {
    const p = new Date(plantio);
    const v = new Date(visita);
    if (!isNaN(p.getTime()) && !isNaN(v.getTime())) {
      const dap = Math.floor((v - p) / (1000 * 60 * 60 * 24));
      document.getElementById('dapValue').textContent = dap;
      document.getElementById('dapInfo').style.display = 'block';
      saveToStorage();
    }
  }
}

function getCurrentLocation() {
  if (!navigator.geolocation) return;

  navigator.geolocation.getCurrentPosition(
    function(position) {
      const lat = position.coords.latitude.toFixed(6);
      const lng = position.coords.longitude.toFixed(6);
      document.getElementById('coordenadas').value = `${lat}, ${lng}`;
      saveToStorage();
    },
    function(error) {
      console.warn('Geolocaliza√ß√£o n√£o obtida:', error.message);
    }
  );
}

// --- EXPORTA√á√ÉO PDF ---
async function exportToPDF() {
  const loadingDiv = document.createElement('div');
  loadingDiv.style.position = 'fixed';
  loadingDiv.style.top = '0';
  loadingDiv.style.left = '0';
  loadingDiv.style.right = '0';
  loadingDiv.style.bottom = '0';
  loadingDiv.style.backgroundColor = 'rgba(0,0,0,0.7)';
  loadingDiv.style.display = 'flex';
  loadingDiv.style.justifyContent = 'center';
  loadingDiv.style.alignItems = 'center';
  loadingDiv.style.color = 'white';
  loadingDiv.style.fontSize = '1.2em';
  loadingDiv.style.zIndex = '10000';
  loadingDiv.textContent = 'Gerando PDF...';
  document.body.appendChild(loadingDiv);

  try {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p', 'mm', 'a4');
    const pageWidth = pdf.internal.pageSize.getWidth();
    const margin = 15;
    const contentWidth = pageWidth - (2 * margin);
    let yPosition = 35;

    const fontFamily = 'helvetica';
    const addText = (text, x, y, size = 12, style = 'normal') => {
      pdf.setFont(fontFamily, style);
      pdf.setFontSize(size);
      pdf.text(text, x, y);
    };

    const addSection = (title, content, isMultiline = false) => {
      if (yPosition > 270) { pdf.addPage(); yPosition = 20; }
      addText(title, margin, yPosition, 10, 'bold');
      yPosition += 5;
      if (isMultiline) {
        const lines = pdf.splitTextToSize(content, contentWidth);
        lines.forEach(line => {
          if (yPosition > 270) { pdf.addPage(); yPosition = 20; }
          addText(line, margin, yPosition, 10);
          yPosition += 5;
        });
        yPosition += 5;
      } else {
        addText(content || '‚Äî', margin + 35, yPosition, 10);
        yPosition += 8;
      }
    };

    // Cabe√ßalho
    pdf.setFont(fontFamily, 'bold');
    pdf.setFontSize(16);
    pdf.text('RELAT√ìRIO DE VISITA AGR√çCOLA', pageWidth / 2, 20, null, null, 'center');

    // Informa√ß√µes da Visita
    addText('Informa√ß√µes da Visita', margin, yPosition, 11, 'bold');
    yPosition += 8;
    addSection('Produtor:', document.getElementById('produtor').value);
    addSection('Propriedade:', document.getElementById('propriedade').value);
    addSection('Data da Visita:', document.getElementById('data').value);
    addSection('√Årea (ha):', document.getElementById('area').value);
    addSection('Cultivar:', document.getElementById('cultivar').value);
    addSection('Data de Plantio:', document.getElementById('plantio').value);
    addSection('DAP:', document.getElementById('dapValue').textContent + ' dias');

    // Est√°dio Fenol√≥gico
    const stageKey = document.getElementById('stageSelect').value;
    if (stageKey) {
      const stage = stages[stageKey];
      addText('Est√°dio Fenol√≥gico', margin, yPosition, 11, 'bold');
      yPosition += 8;
      addSection('Est√°dio:', `${stage.name} (${stage.dapRange} DAP)`);
      if (stage.description) addSection('Descri√ß√£o:', stage.description);
    }

    // Categorias Selecionadas
    if (selectedCategories.size > 0) {
      addText('Problemas Identificados', margin, yPosition, 11, 'bold');
      yPosition += 8;
      selectedCategories.forEach(catId => {
        const cat = categories[catId];
        addText(`${cat.icon} ${cat.name}`, margin, yPosition, 10, 'bold');
        yPosition += 7;
        if (cat.nutrients) {
          const sel = Array.from(selectedNutrients).join(', ');
          if (sel) addSection('Nutrientes:', sel);
        }
        const severity = severityData[catId] || 'nenhum';
        const severityLabels = { nenhum: 'Nenhum', baixa: 'Baixa', media: 'M√©dia', alta: 'Alta' };
        addSection('Severidade:', severityLabels[severity]);
        yPosition += 3;
      });
    }

    // Fotos
    if (photos.length > 0) {
      const photoSize = document.getElementById('photoSizeSelect').value;
      let maxHeight;
      switch (photoSize) {
        case 'small': maxHeight = 40; break;
        case 'large': maxHeight = 80; break;
        default: maxHeight = 60;
      }

      addText('Fotos', margin, yPosition, 11, 'bold');
      yPosition += 8;
      for (let i = 0; i < photos.length; i++) {
        const photo = photos[i];
        const photoType = photoTypes[photo.type];
        if (yPosition + maxHeight + 20 > 277) {
          pdf.addPage();
          yPosition = margin;
        }
        addText(`${photo.categoryName} - ${photoType.name}`, margin, yPosition, 9, 'bold');
        yPosition += 5;
        try {
          pdf.addImage(photo.data, 'JPEG', margin, yPosition, contentWidth, maxHeight, undefined, 'FAST');
          yPosition += maxHeight + 8;
        } catch (err) {
          addText('[Erro ao adicionar imagem]', margin, yPosition + 5, 9);
          yPosition += 15;
        }
      }
    }

    // Observa√ß√µes, Recomenda√ß√µes, etc.
    const obs = document.getElementById('observacoes').value;
    const rec = document.getElementById('recomendacoes').value;
    const tec = document.getElementById('tecnico').value;
    const coord = document.getElementById('coordenadas').value;

    if (obs) { addText('Observa√ß√µes', margin, yPosition, 11, 'bold'); yPosition += 8; addSection('', obs, true); }
    if (rec) { addText('Recomenda√ß√µes', margin, yPosition, 11, 'bold'); yPosition += 8; addSection('', rec, true); }
    if (tec) { addText('Respons√°vel T√©cnico', margin, yPosition, 11, 'bold'); yPosition += 8; addSection('', tec); }
    if (coord) { addText('Localiza√ß√£o', margin, yPosition, 11, 'bold'); yPosition += 8; addSection('Coordenadas:', coord); }

    // Rodap√©
    const pageCount = pdf.internal.getNumberOfPages();
    for (let i = 1; i <= pageCount; i++) {
      pdf.setPage(i);
      pdf.setFontSize(9);
      pdf.setTextColor(150);
      pdf.text(`P√°gina ${i} de ${pageCount}`, pageWidth / 2, 287, null, null, 'center');
    }

    pdf.save(`relatorio_visita_${new Date().toISOString().slice(0,10)}.pdf`);
  } catch (err) {
    console.error(err);
    alert('Erro ao gerar PDF: ' + err.message);
  } finally {
    document.body.removeChild(loadingDiv);
  }
}
</script>
</body>
</html>

