width: 30px; height: 30px    width: 50px; height: 50px<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relat√≥rio de Visita Agr√≠cola</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(to bottom, #f5f5f7 0%, #e8e8ea 100%);
            padding: 0;
            min-height: 100vh;
        }

        .header-bar {
            background: linear-gradient(180deg, #2c2c2e 0%, #1c1c1e 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.12);
        }

        .header-close {
            font-size: 1.3em;
            cursor: pointer;
        }

        .header-title {
            font-size: 1em;
            font-weight: 500;
        }

        .header-save {
            color: #007AFF;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .header-action {
            cursor: pointer;
            padding: 6px 12px;
            border-radius: 6px;
            transition: background 0.2s;
        }

        .header-action:hover {
            background: rgba(0, 122, 255, 0.1);
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding-bottom: 100px;
        }

        .content {
            padding: 0;
        }

        .section {
            background: white;
            border-radius: 12px;
            margin: 12px 16px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08), 
                        0 2px 8px rgba(0, 0, 0, 0.04);
        }

        .section-title {
            font-size: 0.75em;
            color: #86868b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 15px;
            font-weight: 500;
        }

        .form-row {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #e5e5e7;
        }

        .form-row:last-child {
            border-bottom: none;
        }

        label {
            flex: 0 0 100px;
            color: #1d1d1f;
            font-size: 1em;
            font-weight: 400;
        }

        input[type="text"],
        input[type="date"],
        input[type="number"],
        textarea,
        select {
            flex: 1;
            padding: 8px 0;
            border: none;
            font-size: 1em;
            color: #1d1d1f;
            background: transparent;
            text-align: right;
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
        }

        textarea {
            text-align: left;
            min-height: 80px;
            resize: vertical;
            padding: 12px 0;
        }

        .stage-display {
            width: 30px; height: 30px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(245, 245, 247, 0.98) 100%);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 24px;
            text-align: center;
            margin: 15px 0;
            border: 1px solid rgba(0, 0, 0, 0.05);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08),
                        0 8px 32px rgba(0, 0, 0, 0.04),
                        inset 0 1px 0 rgba(255, 255, 255, 0.8);
        }

        .stage-display.active {
            display: block;
            animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .stage-icon-large {
            width: 80px;
            height: 80px;
            margin: 0 auto 15px;
        }

        .stage-icon-large img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .stage-name-large {
            font-size: 1.2em;
            font-weight: 600;
            color: #1d1d1f;
            margin-bottom: 5px;
        }

        .stage-description-large {
            font-size: 0.9em;
            color: #86868b;
            margin-bottom: 10px;
        }

        .dap-badge {
            display: inline-block;
            background: #007AFF;
            color: white;
            padding: 6px 14px;
            border-radius: 16px;
            font-weight: 500;
            font-size: 0.85em;
        }

        .attention-points {
            background: linear-gradient(135deg, #fff8e1 0%, #fff3cd 100%);
            border-radius: 12px;
            padding: 16px;
            margin: 15px 0 0 0;
            border: 1px solid rgba(255, 193, 7, 0.2);
            box-shadow: 0 2px 8px rgba(255, 152, 0, 0.08),
                        inset 0 1px 0 rgba(255, 255, 255, 0.5);
        }

        .attention-points h3 {
            color: #856404;
            margin-bottom: 12px;
            font-size: 0.9em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .attention-points ul {
            list-style: none;
            padding-left: 0;
        }

        .attention-points li {
            padding: 10px 12px;
            margin-bottom: 6px;
            font-size: 0.85em;
            color: #856404;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 8px;
            border-left: 3px solid #ffc107;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .attention-points li:last-child {
            margin-bottom: 0;
        }

        /* Category Grid */
        .category-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
            margin: 15px 0;
        }

        .category-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .category-item:active {
            transform: scale(0.95);
        }

        .category-circle {
            width: 65px;
            height: 65px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12),
                        0 4px 12px rgba(0, 0, 0, 0.08);
            position: relative;
            overflow: hidden;
        }

        .category-circle img {
width: 55px;            height: 55px;
            object-fit: contain;
            width: 30px; height: 30px;
        }

        /* Unselected state - gray/muted */
        .category-circle.doenca,
        .category-circle.insetos,
        .category-circle.ervas,
        .category-circle.nutrientes,
        .category-circle.agua {
            background: #e8e8e8;
        }

        /* Selected state - vibrant colors */
        .category-item.selected .category-circle.doenca { 
            background: linear-gradient(135deg, #34C759 0%, #28a745 100%);
            box-shadow: 0 4px 16px rgba(52, 199, 89, 0.4);
        }
        .category-item.selected .category-circle.insetos { 
            background: linear-gradient(135deg, #FF2D55 0%, #e0204d 100%);
            box-shadow: 0 4px 16px rgba(255, 45, 85, 0.4);
        }
        .category-item.selected .category-circle.ervas { 
            background: linear-gradient(135deg, #FF9500 0%, #e68600 100%);
            box-shadow: 0 4px 16px rgba(255, 149, 0, 0.4);
        }
        .category-item.selected .category-circle.nutrientes { 
            background: linear-gradient(135deg, #8E8E93 0%, #6d6d72 100%);
            box-shadow: 0 4px 16px rgba(142, 142, 147, 0.4);
        }
        .category-item.selected .category-circle.agua { 
            background: linear-gradient(135deg, #30B0C7 0%, #28a0b5 100%);
            box-shadow: 0 4px 16px rgba(48, 176, 199, 0.4);
        }

        .category-name {
            font-size: 0.75em;
            color: #86868b;
            text-align: center;
            font-weight: 400;
            transition: color 0.2s;
        }

        .category-item.selected .category-name {
            color: #1d1d1f;
            font-weight: 500;
        }

        /* Problem Section */
        .problem-section {
            background: white;
            border-radius: 12px;
            margin: 12px 16px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08), 
                        0 2px 8px rgba(0, 0, 0, 0.04);
        }

        .problem-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 20px;
            border-bottom: 1px solid #e5e5e7;
        }

        .problem-icon-large {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .problem-icon-large img {
            width: 28px;
            height: 28px;
            object-fit: contain;
        }

        .problem-icon-large.doenca { background: linear-gradient(135deg, #34C759 0%, #28a745 100%); }
        .problem-icon-large.insetos { background: linear-gradient(135deg, #FF2D55 0%, #e0204d 100%); }
        .problem-icon-large.ervas { background: linear-gradient(135deg, #FF9500 0%, #e68600 100%); }
        .problem-icon-large.nutrientes { background: linear-gradient(135deg, #8E8E93 0%, #6d6d72 100%); }
        .problem-icon-large.agua { background: linear-gradient(135deg, #30B0C7 0%, #28a0b5 100%); }

        .problem-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #1d1d1f;
        }

        .problem-content {
            padding: 16px 20px;
        }

        /* Problem Notes */
        .problem-notes {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e5e5e7;
        }

        .problem-notes-input {
            width: 100%;
            min-height: 70px;
            padding: 12px;
            border: 1px solid #e5e5e7;
            border-radius: 10px;
            font-size: 0.9em;
            font-family: inherit;
            resize: vertical;
            background: #fafafa;
            transition: border-color 0.2s, background 0.2s;
        }

        .problem-notes-input:focus {
            outline: none;
            border-color: #007AFF;
            background: white;
        }

        .problem-notes-input::placeholder {
            color: #86868b;
        }

        /* Severity Slider */
        .severity-slider-container {
            padding: 12px 0;
        }

        .severity-slider-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .severity-label {
            font-size: 0.9em;
            color: #1d1d1f;
            font-weight: 500;
        }

        .severity-value {
            font-size: 0.85em;
            font-weight: 600;
            padding: 4px 12px;
            border-radius: 12px;
            min-width: 60px;
            text-align: center;
        }

        .severity-value.nenhum { background: #f0f0f0; color: #8e8e93; }
        .severity-value.baixa { background: #fff3cd; color: #856404; }
        .severity-value.media { background: #ffe5d0; color: #cc5500; }
        .severity-value.alta { background: #ffe0e0; color: #d32f2f; }

        .severity-slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: linear-gradient(to right, #f0f0f0 0%, #fff3cd 33%, #ffe5d0 66%, #ffe0e0 100%);
            outline: none;
            -webkit-appearance: none;
        }

        .severity-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            border: 2px solid #007AFF;
        }

        /* Nutrient Grid */
        .nutrient-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .nutrient-badge {
            padding: 10px 8px;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 600;
            background: white;
            color: #1d1d1f;
            transition: all 0.2s;
            border: 1.5px solid rgba(0, 0, 0, 0.08);
        }

        .nutrient-badge.selected {
            background: linear-gradient(135deg, #FF9500 0%, #FF8000 100%);
            color: white;
            border-color: transparent;
            box-shadow: 0 4px 12px rgba(255, 149, 0, 0.35);
        }

        .nutrient-badge-icon {
            font-size: 1.1em;
            font-weight: 700;
        }

        .nutrient-badge-name {
            font-size: 0.7em;
            font-weight: 500;
            margin-top: 2px;
        }

        /* Photo Section within Problem */
        .problem-photos {
            background: #f8f8f8;
            border-radius: 10px;
            padding: 12px;
            margin-top: 15px;
        }

        .problem-photos-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .problem-photos-title {
            font-size: 0.8em;
            color: #86868b;
            font-weight: 500;
        }

        .add-photo-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, #007AFF 0%, #0051D5 100%);
            color: white;
            border: none;
            font-size: 1.2em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0, 122, 255, 0.3);
            transition: transform 0.2s;
        }

        .add-photo-icon:active {
            transform: scale(0.9);
        }

        .photo-thumb-grid {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .photo-thumb {
            width: 70px;
            height: 70px;
            border-radius: 10px;
            object-fit: cover;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .photo-thumb-container {
            position: relative;
        }

        .photo-thumb-remove {
            position: absolute;
            top: -6px;
            right: -6px;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: #FF3B30;
            color: white;
            border: 2px solid white;
            font-size: 0.8em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Floating Photo Button */
        .floating-photo-btn {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 30px; height: 30px;
            align-items: center;
            gap: 10px;
            padding: 14px 24px;
            background: linear-gradient(135deg, #007AFF 0%, #0051D5 100%);
            color: white;
            border-radius: 30px;
            box-shadow: 0 6px 20px rgba(0, 122, 255, 0.4);
            cursor: pointer;
            z-index: 90;
            animation: bounceIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .floating-photo-btn.active {
            display: flex;
        }

        @keyframes bounceIn {
            0% { opacity: 0; transform: translateX(-50%) scale(0.8); }
            50% { transform: translateX(-50%) scale(1.05); }
            100% { opacity: 1; transform: translateX(-50%) scale(1); }
        }

        .floating-photo-btn-icon {
            font-size: 1.3em;
        }

        .floating-photo-btn-text {
            font-weight: 600;
            font-size: 0.95em;
        }

        .floating-photo-btn-category {
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.85em;
        }

        .floating-photo-btn-category img {
            width: 20px;
            height: 20px;
            object-fit: contain;
        }

        /* Full Photo View Section */
        .section-photos-full {
            background: white;
            border-radius: 12px;
            margin: 12px 16px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        }

        .photos-list-full {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 15px;
        }

        .photo-item-full {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .photo-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: linear-gradient(to bottom, #fafafa 0%, #f5f5f7 100%);
            border-bottom: 1px solid rgba(0, 0, 0, 0.06);
        }

        .photo-item-type {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            color: #1d1d1f;
            font-size: 0.9em;
        }

        .photo-item-type img {
            width: 24px;
            height: 24px;
            object-fit: contain;
        }

        .photo-item-remove {
            background: #FF3B30;
            color: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            font-size: 1.1em;
            cursor: pointer;
        }

        .photo-item-image {
            width: 100%;
            object-fit: cover;
            cursor: pointer;
        }

        .photo-size-slider-container {
            padding: 12px 16px;
            background: #fafafa;
            border-top: 1px solid rgba(0, 0, 0, 0.06);
        }

        .photo-size-slider-label {
            font-size: 0.8em;
            color: #86868b;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
        }

        .photo-size-value {
            color: #007AFF;
            font-weight: 600;
        }

        .photo-size-slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #e5e5e7;
            outline: none;
            -webkit-appearance: none;
        }

        .photo-size-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: linear-gradient(135deg, #007AFF 0%, #0051D5 100%);
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 122, 255, 0.4);
        }

        /* PDF Settings */
        .pdf-settings-section {
            background: linear-gradient(135deg, #e8f4ff 0%, #f0f8ff 100%);
            border-radius: 12px;
            padding: 16px;
            margin: 15px 0 0 0;
            border: 1px solid rgba(0, 122, 255, 0.2);
        }

        .pdf-settings-title {
            color: #007AFF;
            font-size: 0.9em;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .pdf-setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(0, 122, 255, 0.1);
        }

        .pdf-setting-row:last-child {
            border-bottom: none;
        }

        .pdf-setting-label {
            font-size: 0.9em;
            color: #1d1d1f;
            font-weight: 500;
        }

        .pdf-setting-value {
            font-size: 0.85em;
            color: #007AFF;
            font-weight: 600;
        }

        .photo-size-btn {
            padding: 6px 10px;
            border-radius: 6px;
            border: 1.5px solid rgba(0, 0, 0, 0.08);
            background: white;
            color: #1d1d1f;
            font-size: 0.75em;
            font-weight: 600;
            cursor: pointer;
        }

        .photo-size-btn.active {
            background: linear-gradient(135deg, #007AFF 0%, #0051D5 100%);
            color: white;
            border-color: transparent;
        }

        /* Save Indicator */
        .save-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(52, 199, 89, 0.95);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 0.85em;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1000;
        }

        .save-indicator.show {
            opacity: 1;
        }

        /* Modal */
        .modal {
            width: 30px; height: 30px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            z-index: 1000;
            align-items: flex-end;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px 12px 0 0;
            width: 100%;
            max-width: 800px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #e5e5e7;
        }

        .modal-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #1d1d1f;
        }

        .modal-options {
            padding: 10px 0;
        }

        .modal-option {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 20px;
            cursor: pointer;
            border-bottom: 1px solid #e5e5e7;
        }

        .modal-option:active {
            background: #f5f5f7;
        }

        .modal-option-icon {
            font-size: 1.8em;
        }

        .modal-option-name {
            font-size: 1em;
            color: #1d1d1f;
        }

        .modal-cancel {
            padding: 15px 20px;
            text-align: center;
            color: #007AFF;
            font-weight: 600;
            cursor: pointer;
            border-top: 1px solid #e5e5e7;
        }

        .dap-info {
            background: #f5f5f7;
            border-radius: 8px;
            padding: 10px 15px;
            margin-top: 10px;
            text-align: center;
        }

        .dap-info strong {
            color: #007AFF;
        }

        input[type="file"] {
            width: 30px; height: 30px;
        }

        @media (max-width: 600px) {
            .category-grid {
                gap: 10px;
            }

            .category-circle {
                width: 55px;
                height: 55px;
            }

            .category-circle img {
                width: 32px;
                height: 32px;
            }

            .category-name {
                font-size: 0.7em;
            }

            .nutrient-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="header-bar">
        <div class="header-close" onclick="clearLocalStorage()">üóëÔ∏è</div>
        <div class="header-title">Relat√≥rio de Visita</div>
        <div class="header-save">
            <div class="header-action" onclick="exportToPDF()">PDF</div>
            <div class="header-action" onclick="window.print()">üñ®Ô∏è</div>
        </div>
    </div>

    <div class="container">
        <div class="content">
            <!-- Informa√ß√µes da Visita -->
            <div class="section">
                <div class="section-title">Informa√ß√µes da Visita</div>
                <div class="form-row">
                    <label>Produtor</label>
                    <input type="text" id="produtor" placeholder="Nome">
                </div>
                <div class="form-row">
                    <label>Propriedade</label>
                    <input type="text" id="propriedade" placeholder="Nome">
                </div>
                <div class="form-row">
                    <label>Data</label>
                    <input type="date" id="data">
                </div>
                <div class="form-row">
                    <label>√Årea (ha)</label>
                    <input type="number" id="area" placeholder="0.00" step="0.01">
                </div>
                <div class="form-row">
                    <label>Cultivar</label>
                    <input type="text" id="cultivar" placeholder="TMG 7062">
                </div>
                <div class="form-row">
                    <label>Plantio</label>
                    <input type="date" id="plantio" onchange="calculateDAP()">
                </div>
                <div class="dap-info" id="dapInfo" style="width: 30px; height: 30px;">
                    <strong>DAP: <span id="dapValue">0</span> dias</strong>
                </div>
            </div>

            <!-- Est√°dio Fenol√≥gico -->
            <div class="section">
                <div class="section-title">Est√°dio Fenol√≥gico</div>
                <div class="form-row">
                    <label>Est√°dio</label>
                    <select id="stageSelect" onchange="showStageInfo()">
                        <option value="">Selecione</option>
                        <option value="VE">VE - Emerg√™ncia</option>
                        <option value="VC">VC - Cotil√©dones</option>
                        <option value="V1">V1 - 1¬™ Trifoliolada</option>
                        <option value="V2">V2 - 2¬™ Trifoliolada</option>
                        <option value="V3">V3 - 3¬™ Trifoliolada</option>
                        <option value="V4">V4 - 4¬™ Trifoliolada</option>
                        <option value="V5">V5 - 5¬™ Trifoliolada</option>
                        <option value="R1">R1 - Florescimento</option>
                        <option value="R2">R2 - Flora√ß√£o Plena</option>
                        <option value="R3">R3 - Vagens 1cm</option>
                        <option value="R4">R4 - Vagens 2cm</option>
                        <option value="R5.1">R5.1 - In√≠cio Enchimento</option>
                        <option value="R5.3">R5.3 - 50% Enchimento</option>
                        <option value="R5.5">R5.5 - 100% Enchimento</option>
                        <option value="R6">R6 - Gr√£os Formados</option>
                        <option value="R7">R7 - In√≠cio Matura√ß√£o</option>
                        <option value="R8">R8 - Matura√ß√£o Plena</option>
                    </select>
                </div>

                <div class="stage-display" id="stageDisplay">
                    <div class="stage-icon-large" id="stageIcon"></div>
                    <div class="stage-name-large" id="stageName"></div>
                    <div class="stage-description-large" id="stageDescription"></div>
                    <div class="dap-badge" id="stageDap"></div>
                </div>

                <div class="attention-points" id="attentionPoints" style="width: 30px; height: 30px;">
                    <h3>‚ö†Ô∏è Pontos de Aten√ß√£o</h3>
                    <ul id="attentionList"></ul>
                </div>
            </div>

            <!-- Categorias -->
            <div class="section">
                <div class="section-title">Categoria</div>
                <div class="category-grid">
                    <div class="category-item" onclick="toggleCategory('doenca')" data-category="doenca">
                        <div class="category-circle doenca">
                            <img src="doencas.png" alt="Doen√ßa">
                        </div>
                        <div class="category-name">Doen√ßa</div>
                    </div>
                    <div class="category-item" onclick="toggleCategory('insetos')" data-category="insetos">
                        <div class="category-circle insetos">
                            <img src="insetos.png" alt="Insetos">
                        </div>
                        <div class="category-name">Insetos</div>
                    </div>
                    <div class="category-item" onclick="toggleCategory('ervas')" data-category="ervas">
                        <div class="category-circle ervas">
                            <img src="ervas.png" alt="Ervas daninhas">
                        </div>
                        <div class="category-name">Ervas daninhas</div>
                    </div>
                    <div class="category-item" onclick="toggleCategory('nutrientes')" data-category="nutrientes">
                        <div class="category-circle nutrientes">
                            <img src="nutricional.png" alt="Nutrientes">
                        </div>
                        <div class="category-name">Nutrientes</div>
                    </div>
                    <div class="category-item" onclick="toggleCategory('agua')" data-category="agua">
                        <div class="category-circle agua">
                            <img src="estresse.png" alt="√Ågua">
                        </div>
                        <div class="category-name">√Ågua</div>
                    </div>
                </div>
            </div>

            <!-- Problems Container -->
            <div id="problemsContainer"></div>

            <!-- Full Photos Section -->
            <div class="section-photos-full" id="fullPhotosSection" style="width: 30px; height: 30px;">
                <div class="section-title">Todas as Fotos</div>
                <div class="photos-list-full" id="photosListFull"></div>
                
                <div class="pdf-settings-section" id="pdfSettings" style="width: 30px; height: 30px;">
                    <div class="pdf-settings-title">üìÑ Configura√ß√µes do PDF</div>
                    <div class="pdf-setting-row">
                        <div class="pdf-setting-label">Qualidade</div>
                        <div style="display: flex; gap: 6px;">
                            <button class="photo-size-btn" onclick="setPhotoQuality('baixa', this)">Baixa</button>
                            <button class="photo-size-btn active" onclick="setPhotoQuality('media', this)">M√©dia</button>
                            <button class="photo-size-btn" onclick="setPhotoQuality('alta', this)">Alta</button>
                        </div>
                    </div>
                    <div class="pdf-setting-row">
                        <div class="pdf-setting-label">Fotos/P√°gina</div>
                        <div style="display: flex; gap: 6px;">
                            <button class="photo-size-btn active" onclick="setPhotosPerPage(1, this)">1</button>
                            <button class="photo-size-btn" onclick="setPhotosPerPage(2, this)">2</button>
                            <button class="photo-size-btn" onclick="setPhotosPerPage(3, this)">3</button>
                        </div>
                    </div>
                    <div class="pdf-setting-row" style="border: none;">
                        <div class="pdf-setting-label">Tamanho</div>
                        <div class="pdf-setting-value" id="estimatedSize">~2.5 MB</div>
                    </div>
                </div>
            </div>

            <!-- Observa√ß√µes -->
            <div class="section">
                <div class="section-title">Observa√ß√µes</div>
                <div class="form-row">
                    <textarea id="observacoes" placeholder="Observa√ß√µes gerais sobre a lavoura..."></textarea>
                </div>
            </div>

            <!-- Recomenda√ß√µes -->
            <div class="section">
                <div class="section-title">Recomenda√ß√µes</div>
                <div class="form-row">
                    <textarea id="recomendacoes" placeholder="Recomenda√ß√µes t√©cnicas..."></textarea>
                </div>
            </div>

            <!-- Respons√°vel -->
            <div class="section">
                <div class="section-title">Respons√°vel</div>
                <div class="form-row">
                    <input type="text" id="tecnico" placeholder="Nome do t√©cnico">
                </div>
            </div>

            <!-- Localiza√ß√£o -->
            <div class="section">
                <div class="section-title">Localiza√ß√£o</div>
                <div class="form-row">
                    <label>Coordenadas</label>
                    <input type="text" id="coordenadas" placeholder="Pin" readonly>
                </div>
                <div style="padding: 12px 0; color: #007AFF; cursor: pointer; font-size: 0.95em;" onclick="getCurrentLocation()">
                    üìç Definir localiza√ß√£o atual
                </div>
            </div>

            <!-- Tipo de Ocorr√™ncia -->
            <div class="section">
                <div class="section-title">Tipo de Ocorr√™ncia</div>
                <div style="display: flex; gap: 30px; padding: 12px 0;">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; flex: none;">
                        <input type="radio" name="tipo" value="sazonal" checked style="width: 30px; height: 30px;">
                        <span>Sazonal</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; flex: none;">
                        <input type="radio" name="tipo" value="permanente" style="width: 30px; height: 30px;">
                        <span>Permanente</span>
                    </label>
                </div>
            </div>

            <!-- Amostras -->
            <div class="section">
                <div class="section-title">Amostras</div>
                <div style="padding: 12px 0;">
                    <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                        <input type="checkbox" id="amostraSolo" style="width: 22px; height: 22px;">
                        <span>Amostra de solo</span>
                    </label>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Photo Button -->
    <div class="floating-photo-btn" id="floatingPhotoBtn" onclick="takePhotoForActiveCategory()">
        <span class="floating-photo-btn-icon">üì∑</span>
        <span class="floating-photo-btn-text">Pr√≥xima foto:</span>
        <span class="floating-photo-btn-category" id="floatingCategoryName">
            <img src="doencas.png" alt="" id="floatingCategoryIcon">
            <span id="floatingCategoryText">Doen√ßa</span>
        </span>
    </div>

    <input type="file" id="photoInput" accept="image/*" capture="environment" onchange="handlePhoto()">

    <div class="save-indicator" id="saveIndicator">‚úì Salvo</div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        // Caminho base para as imagens
        const IMG_PATH = '/';

        // Stage data with image paths
        const stages = {
            'VE': { 
                img: 've.png', 
                name: 'VE - Emerg√™ncia', 
                description: 'Cotil√©dones rompem o solo', 
                dap: '0 DAP',
                attention: [
                    'Absor√ß√£o de √°gua: m√≠nimo 50% do peso da semente',
                    'Temperatura ideal do solo: 20-30¬∞C',
                    'In√≠cio da coloniza√ß√£o por Bradyrhizobium',
                    'Embebi√ß√£o completa - eventos metab√≥licos preparando rad√≠cula'
                ] 
            },
            'VC': { 
                img: 'vc.png', 
                name: 'VC - Cotil√©dones', 
                description: 'Cotil√©dones totalmente abertos', 
                dap: '3 DAP',
                attention: [
                    'Planta utiliza reservas dos cotil√©dones',
                    'Perda de 2 cotil√©dones pode reduzir 9% do rendimento',
                    'Controle de plantas daninhas cr√≠tico',
                    'Desenvolvimento do sistema radicular'
                ] 
            },
            'V1': { 
                img: 'v1.png', 
                name: 'V1 - 1¬™ Trifoliolada', 
                description: 'Primeira folha trifoliolada desenvolvida', 
                dap: '8 DAP',
                attention: [
                    'Fotoss√≠ntese sustenta o crescimento (independ√™ncia dos cotil√©dones)',
                    'Nova folha a cada 5 dias at√© V5',
                    'Fixa√ß√£o biol√≥gica de N‚ÇÇ em desenvolvimento',
                    'Alta concentra√ß√£o de auxina - crescimento vegetativo'
                ] 
            },
            'V2': { 
                img: 'v2.png', 
                name: 'V2 - 2¬™ Trifoliolada', 
                description: 'Segunda folha trifoliolada', 
                dap: '16 DAP',
                attention: [
                    'Crescimento vegetativo intenso',
                    'Aumento da demanda nutricional',
                    'Controle de plantas daninhas',
                    'Intercepta√ß√£o de luz aumentando'
                ] 
            },
            'V3': { 
                img: 'v3.png', 
                name: 'V3 - 3¬™ Trifoliolada', 
                description: 'Terceira folha trifoliolada', 
                dap: '18 DAP',
                attention: [
                    'Per√≠odo cr√≠tico para competi√ß√£o com daninhas',
                    'Crescimento radicular ativo',
                    'Demanda h√≠drica aumentando',
                    'Posicionamento de reguladores de crescimento'
                ] 
            },
            'V4': { 
                img: 'v4.png', 
                name: 'V4 - 4¬™ Trifoliolada', 
                description: 'Quarta folha trifoliolada', 
                dap: '20 DAP',
                attention: [
                    'M√°ximo crescimento vegetativo',
                    'Alta demanda de √°gua e nutrientes',
                    'Controle de pragas (lagartas, percevejos)',
                    'Arquitetura de planta definindo potencial produtivo'
                ] 
            },
            'V5': { 
                img: 'v5.png', 
                name: 'V5 - 5¬™ Trifoliolada', 
                description: 'Quinta folha trifoliolada', 
                dap: '25 DAP',
                attention: [
                    'A partir daqui: nova folha a cada 3 dias',
                    'Prepara√ß√£o para fase reprodutiva',
                    'Controle fitossanit√°rio intensivo',
                    'Auxinas em alta concentra√ß√£o'
                ] 
            },
            'R1': { 
                img: 'r1.png', 
                name: 'R1 - Florescimento', 
                description: 'Uma flor aberta em qualquer n√≥', 
                dap: '25 DAP',
                attention: [
                    'In√≠cio da fase reprodutiva (fotoper√≠odo cr√≠tico)',
                    'D√©ficit h√≠drico extremamente cr√≠tico',
                    'Boro essencial para forma√ß√£o do tubo pol√≠nico',
                    'Estresse t√©rmico causa abortamento de flores',
                    'Intensificar fotoss√≠ntese para reservas'
                ] 
            },
            'R2': { 
                img: 'r2.png', 
                name: 'R2 - Flora√ß√£o Plena', 
                description: 'Flor aberta no ter√ßo superior', 
                dap: '62 DAP',
                attention: [
                    'Pleno florescimento da cultura',
                    'M√°xima demanda h√≠drica (5-7 mm/dia)',
                    'Estresse t√©rmico cr√≠tico para abortamento',
                    'Etileno e ABA induzem queda de flores',
                    'Controle de pragas desfolhadoras'
                ] 
            },
            'R3': { 
                img: 'r3.png', 
                name: 'R3 - Forma√ß√£o de Vagens', 
                description: 'Vagem com 1cm nos √∫ltimos 4 n√≥s', 
                dap: '60-70 DAP',
                attention: [
                    'Forma√ß√£o inicial das vagens',
                    'Transloca√ß√£o de fotoassimilados para vagens',
                    'N√∫mero potencial de vagens definindo',
                    'Monitoramento de percevejos intensificado'
                ] 
            },
            'R4': { 
                img: 'r4.png', 
                name: 'R4 - Vagens Desenvolvidas', 
                description: 'Vagem com 5mm nos 4 primeiros n√≥s', 
                dap: '72 DAP',
                attention: [
                    'Vagens em pleno desenvolvimento',
                    'Componente de produtividade: n√∫mero de vagens',
                    'Percevejos causam grande impacto',
                    'Nutri√ß√£o foliar para sustenta√ß√£o'
                ] 
            },
            'R5.1': { 
                img: 'r5-1.png', 
                name: 'R5.1 - In√≠cio Enchimento', 
                description: 'Gr√£os com 10% de grana√ß√£o', 
                dap: '95 DAP',
                attention: [
                    'M√°ximo desenvolvimento de √°rea foliar e ra√≠zes',
                    'Fixa√ß√£o de N‚ÇÇ no m√°ximo',
                    'Transloca√ß√£o via fluxo de seiva (5-7 mm/dia)',
                    'D√©ficit h√≠drico reduz dura√ß√£o do per√≠odo'
                ] 
            },
            'R5.3': { 
                img: 'r5-3.png', 
                name: 'R5.3 - Enchimento 50%', 
                description: 'Gr√£os com 50% de grana√ß√£o', 
                dap: '90-100 DAP',
                attention: [
                    'Enchimento de gr√£os acelerado',
                    'Per√≠odo cr√≠tico para estresses',
                    'Percevejos afetam qualidade dos gr√£os',
                    'Lagartas reduzem √°rea fotossint√©tica'
                ] 
            },
            'R5.5': { 
                img: 'r5-5.png', 
                name: 'R5.5 - Enchimento Completo', 
                description: 'Gr√£os com 100% de grana√ß√£o', 
                dap: '100-110 DAP',
                attention: [
                    'Gr√£os completamente cheios',
                    'M√°ximo ac√∫mulo de mat√©ria seca nos gr√£os',
                    'Controle de percevejos ainda necess√°rio',
                    'Prepara√ß√£o para matura√ß√£o'
                ] 
            },
            'R6': { 
                img: 'r6.png', 
                name: 'R6 - Gr√£os Formados', 
                description: 'Gr√£os totalmente formados', 
                dap: '95 DAP',
                attention: [
                    'M√°xima mat√©ria seca acumulada',
                    'Plantas n√£o absorvem mais √°gua e nutrientes',
                    'Percevejos afetam germina√ß√£o e vigor',
                    'Monitoramento para produ√ß√£o de sementes'
                ] 
            },
            'R7': { 
                img: 'r7.png', 
                name: 'R7 - In√≠cio Matura√ß√£o', 
                description: 'Gr√£os totalmente formados', 
                dap: '95 DAP',
                attention: [
                    'In√≠cio da senesc√™ncia',
                    'Degrada√ß√£o de clorofila e prote√≠nas',
                    'Etileno e ABA regulam senesc√™ncia',
                    'Mobiliza√ß√£o de reservas para gr√£os',
                    'Aten√ß√£o ao momento de desseca√ß√£o'
                ] 
            },
            'R8': { 
                img: 'r8.png', 
                name: 'R8 - Matura√ß√£o Plena', 
                description: '95% das vagens maduras', 
                dap: '110 DAP',
                attention: [
                    'Matura√ß√£o completa (fim do ciclo biol√≥gico)',
                    'Umidade ideal para colheita: 13-15%',
                    'Evitar danos mec√¢nicos na colheita',
                    'Perda de folhas completa',
                    'Sementes com todas as partes formadas'
                ] 
            }
        };

        const categories = {
            'doenca': { 
                img: 'doencas.png', 
                title: 'Doen√ßa', 
                color: '#34C759',
                type: 'multi',
                levels: [
                    { id: 'incidencia', name: 'Incid√™ncia' },
                    { id: 'severidade', name: 'Severidade' }
                ]
            },
            'insetos': { 
                img: 'insetos.png', 
                title: 'Insetos', 
                color: '#FF2D55',
                type: 'multi',
                levels: [
                    { id: 'desfolha', name: 'Desfolha' },
                    { id: 'infestacao', name: 'Taxa de Infesta√ß√£o' },
                    { id: 'acamamento', name: 'Acamamento' }
                ]
            },
            'ervas': { 
                img: 'ervas.png', 
                title: 'Ervas Daninhas', 
                color: '#FF9500',
                type: 'standard' 
            },
            'nutrientes': { 
                img: 'nutricional.png', 
                title: 'Nutrientes', 
                color: '#8E8E93',
                type: 'nutrients',
                options: [
                    { id: 'N', name: 'N', fullName: 'Nitrog√™nio' },
                    { id: 'P', name: 'P', fullName: 'F√≥sforo' },
                    { id: 'K', name: 'K', fullName: 'Pot√°ssio' },
                    { id: 'Ca', name: 'Ca', fullName: 'C√°lcio' },
                    { id: 'Mg', name: 'Mg', fullName: 'Magn√©sio' },
                    { id: 'S', name: 'S', fullName: 'Enxofre' },
                    { id: 'B', name: 'B', fullName: 'Boro' },
                    { id: 'Zn', name: 'Zn', fullName: 'Zinco' },
                    { id: 'Fe', name: 'Fe', fullName: 'Ferro' },
                    { id: 'Mn', name: 'Mn', fullName: 'Mangan√™s' },
                    { id: 'Cu', name: 'Cu', fullName: 'Cobre' },
                    { id: 'Mo', name: 'Mo', fullName: 'Molibd√™nio' }
                ]
            },
            'agua': { 
                img: 'estresse.png', 
                title: '√Ågua', 
                color: '#30B0C7',
                type: 'water' 
            }
        };

        // State
        let selectedCategories = new Set();
        let activePhotoCategory = null;
        let severityData = {};
        let categoryNotes = {};
        let photos = [];
        let selectedNutrients = new Set();
        let pdfPhotoQuality = 'media';
        let pdfPhotosPerPage = 1;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadFromLocalStorage();
            if (!document.getElementById('data').value) {
                document.getElementById('data').valueAsDate = new Date();
            }
            
            // Auto-save listeners
            document.querySelectorAll('input, select, textarea').forEach(input => {
                input.addEventListener('change', saveToLocalStorage);
                if (input.type === 'text' || input.tagName === 'TEXTAREA') {
                    input.addEventListener('input', debounce(saveToLocalStorage, 1000));
                }
            });
        });

        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func(...args), wait);
            };
        }

        // Category Toggle
        function toggleCategory(id) {
            const item = document.querySelector(`[data-category="${id}"]`);
            
            if (selectedCategories.has(id)) {
                selectedCategories.delete(id);
                item.classList.remove('selected');
                if (activePhotoCategory === id) {
                    activePhotoCategory = selectedCategories.size > 0 ? 
                        Array.from(selectedCategories)[selectedCategories.size - 1] : null;
                }
            } else {
                selectedCategories.add(id);
                item.classList.add('selected');
                activePhotoCategory = id;
            }
            
            renderProblems();
            updateFloatingButton();
            saveToLocalStorage();
        }

        function updateFloatingButton() {
            const btn = document.getElementById('floatingPhotoBtn');
            
            if (selectedCategories.size > 0 && activePhotoCategory) {
                const cat = categories[activePhotoCategory];
                btn.classList.add('active');
                document.getElementById('floatingCategoryIcon').src = IMG_PATH + cat.img;
                document.getElementById('floatingCategoryText').textContent = cat.title;
            } else {
                btn.classList.remove('active');
            }
        }

        function takePhotoForActiveCategory() {
            if (activePhotoCategory) {
                document.getElementById('photoInput').click();
            }
        }

        function handlePhoto() {
            const input = document.getElementById('photoInput');
            if (input.files && input.files[0] && activePhotoCategory) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const cat = categories[activePhotoCategory];
                    photos.push({
                        id: Date.now(),
                        category: activePhotoCategory,
                        categoryImg: cat.img,
                        categoryName: cat.title,
                        data: e.target.result,
                        size: 100
                    });
                    renderProblems();
                    renderFullPhotos();
                    saveToLocalStorage();
                };
                reader.readAsDataURL(input.files[0]);
            }
            input.value = '';
        }

        function addPhotoForCategory(categoryId) {
            activePhotoCategory = categoryId;
            updateFloatingButton();
            document.getElementById('photoInput').click();
        }

        function renderProblems() {
            const container = document.getElementById('problemsContainer');
            container.innerHTML = '';
            
            Array.from(selectedCategories).forEach(id => {
                const cat = categories[id];
                const categoryPhotos = photos.filter(p => p.category === id);
                
                const div = document.createElement('div');
                div.className = 'problem-section';
                
                let contentHTML = '';
                
                if (cat.type === 'multi') {
                    contentHTML = cat.levels.map(level => {
                        const currentValue = severityData[id]?.[level.id] || 'nenhum';
                        const sliderValue = getSeveritySliderValue(currentValue);
                        return `
                            <div class="severity-slider-container">
                                <div class="severity-slider-header">
                                    <span class="severity-label">${level.name}</span>
                                    <span class="severity-value ${currentValue}" id="severity-${id}-${level.id}-value">${capitalizeFirst(currentValue)}</span>
                                </div>
                                <input type="range" class="severity-slider" min="0" max="3" value="${sliderValue}"
                                       oninput="updateSeveritySlider('${id}', '${level.id}', this.value)"
                                       onchange="saveToLocalStorage()">
                            </div>
                        `;
                    }).join('');
                } else if (cat.type === 'nutrients') {
                    contentHTML = `
                        <div class="nutrient-grid">
                            ${cat.options.map(nut => `
                                <div class="nutrient-badge ${selectedNutrients.has(nut.id) ? 'selected' : ''}" 
                                     onclick="toggleNutrient('${nut.id}', this)">
                                    <div class="nutrient-badge-icon">${nut.name}</div>
                                    <div class="nutrient-badge-name">${nut.fullName}</div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else if (cat.type === 'water') {
                    const waterValues = ['adequado', 'seco', 'excesso'];
                    const currentValue = severityData[id]?.main || 'adequado';
                    const sliderValue = waterValues.indexOf(currentValue);
                    contentHTML = `
                        <div class="severity-slider-container">
                            <div class="severity-slider-header">
                                <span class="severity-label">Status</span>
                                <span class="severity-value ${currentValue === 'adequado' ? 'nenhum' : (currentValue === 'seco' ? 'media' : 'alta')}" 
                                      id="severity-${id}-main-value">${capitalizeFirst(currentValue)}</span>
                            </div>
                            <input type="range" class="severity-slider" min="0" max="2" value="${sliderValue}"
                                   oninput="updateWaterSlider('${id}', this.value)"
                                   onchange="saveToLocalStorage()">
                        </div>
                    `;
                } else {
                    const currentValue = severityData[id]?.main || 'nenhum';
                    const sliderValue = getSeveritySliderValue(currentValue);
                    contentHTML = `
                        <div class="severity-slider-container">
                            <div class="severity-slider-header">
                                <span class="severity-label">Severidade</span>
                                <span class="severity-value ${currentValue}" id="severity-${id}-main-value">${capitalizeFirst(currentValue)}</span>
                            </div>
                            <input type="range" class="severity-slider" min="0" max="3" value="${sliderValue}"
                                   oninput="updateSeveritySlider('${id}', 'main', this.value)"
                                   onchange="saveToLocalStorage()">
                        </div>
                    `;
                }
                
                // Notes section for this category
                const categoryNote = categoryNotes[id] || '';
                const notesHTML = `
                    <div class="problem-notes">
                        <textarea class="problem-notes-input" 
                                  id="note-${id}"
                                  placeholder="Anota√ß√µes sobre ${cat.title.toLowerCase()}..."
                                  oninput="updateCategoryNote('${id}', this.value)">${categoryNote}</textarea>
                    </div>
                `;

                // Photos section
                const photosHTML = `
                    <div class="problem-photos">
                        <div class="problem-photos-header">
                            <span class="problem-photos-title">Fotos (${categoryPhotos.length})</span>
                            <button class="add-photo-icon" onclick="addPhotoForCategory('${id}')">üì∑</button>
                        </div>
                        ${categoryPhotos.length > 0 ? `
                            <div class="photo-thumb-grid">
                                ${categoryPhotos.map(p => `
                                    <div class="photo-thumb-container">
                                        <img src="${p.data}" class="photo-thumb" onclick="viewPhoto(${p.id})">
                                        <button class="photo-thumb-remove" onclick="removePhoto(${p.id})">√ó</button>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
                
                div.innerHTML = `
                    <div class="problem-header">
                        <div class="problem-icon-large ${id}">
                            <img src="${IMG_PATH}${cat.img}" alt="${cat.title}">
                        </div>
                        <div class="problem-title">${cat.title}</div>
                    </div>
                    <div class="problem-content">
                        ${contentHTML}
                        ${notesHTML}
                        ${photosHTML}
                    </div>
                `;
                
                container.appendChild(div);
            });
        }

        function renderFullPhotos() {
            const section = document.getElementById('fullPhotosSection');
            const container = document.getElementById('photosListFull');
            const pdfSettings = document.getElementById('pdfSettings');
            
            if (photos.length === 0) {
                section.style.display = 'none';
                return;
            }
            
            section.style.display = 'block';
            pdfSettings.style.display = 'block';
            
            container.innerHTML = photos.map(p => {
                const imageHeight = (p.size || 100) * 2;
                return `
                    <div class="photo-item-full">
                        <div class="photo-item-header">
                            <div class="photo-item-type">
                                <img src="${IMG_PATH}${p.categoryImg}" alt="${p.categoryName}">
                                <span>${p.categoryName}</span>
                            </div>
                            <button class="photo-item-remove" onclick="removePhoto(${p.id})">√ó</button>
                        </div>
                        <img src="${p.data}" class="photo-item-image" style="height: ${imageHeight}px">
                        <div class="photo-size-slider-container">
                            <div class="photo-size-slider-label">
                                <span>Tamanho</span>
                                <span class="photo-size-value">${p.size || 100}%</span>
                            </div>
                            <input type="range" class="photo-size-slider" min="30" max="150" value="${p.size || 100}"
                                   oninput="updatePhotoSize(${p.id}, this.value)"
                                   onchange="saveToLocalStorage()">
                        </div>
                    </div>
                `;
            }).join('');
            
            updateEstimatedSize();
        }

        function updatePhotoSize(photoId, size) {
            const photo = photos.find(p => p.id === photoId);
            if (photo) {
                photo.size = parseInt(size);
                renderFullPhotos();
            }
        }

        function removePhoto(id) {
            photos = photos.filter(p => p.id !== id);
            renderProblems();
            renderFullPhotos();
            saveToLocalStorage();
        }

        function viewPhoto(id) {
            const photo = photos.find(p => p.id === id);
            if (photo) {
                window.open(photo.data, '_blank');
            }
        }

        // Severity functions
        function getSeveritySliderValue(severity) {
            const map = { 'nenhum': 0, 'baixa': 1, 'm√©dia': 2, 'alta': 3 };
            return map[severity] || 0;
        }

        function getSeverityFromSlider(value) {
            const map = { 0: 'nenhum', 1: 'baixa', 2: 'm√©dia', 3: 'alta' };
            return map[value] || 'nenhum';
        }

        function capitalizeFirst(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        function updateSeveritySlider(cat, levelId, value) {
            const severity = getSeverityFromSlider(parseInt(value));
            if (!severityData[cat]) severityData[cat] = {};
            severityData[cat][levelId] = severity;
            
            const valueDisplay = document.getElementById(`severity-${cat}-${levelId}-value`);
            if (valueDisplay) {
                valueDisplay.textContent = capitalizeFirst(severity);
                valueDisplay.className = `severity-value ${severity}`;
            }
        }

        function updateWaterSlider(cat, value) {
            const waterValues = ['adequado', 'seco', 'excesso'];
            const status = waterValues[parseInt(value)];
            if (!severityData[cat]) severityData[cat] = {};
            severityData[cat].main = status;
            
            const valueDisplay = document.getElementById(`severity-${cat}-main-value`);
            if (valueDisplay) {
                valueDisplay.textContent = capitalizeFirst(status);
                const colorClass = status === 'adequado' ? 'nenhum' : (status === 'seco' ? 'media' : 'alta');
                valueDisplay.className = `severity-value ${colorClass}`;
            }
        }

        function toggleNutrient(nutrientId, el) {
            if (selectedNutrients.has(nutrientId)) {
                selectedNutrients.delete(nutrientId);
                el.classList.remove('selected');
            } else {
                selectedNutrients.add(nutrientId);
                el.classList.add('selected');
            }
            saveToLocalStorage();
        }

        function updateCategoryNote(categoryId, value) {
            categoryNotes[categoryId] = value;
            saveToLocalStorage();
        }

        // Stage info
        function showStageInfo() {
            const code = document.getElementById('stageSelect').value;
            if (code && stages[code]) {
                const stage = stages[code];
                document.getElementById('stageDisplay').classList.add('active');
                document.getElementById('stageIcon').innerHTML = `<img src="${IMG_PATH}${stage.img}" alt="${stage.name}">`;
                document.getElementById('stageName').textContent = stage.name;
                document.getElementById('stageDescription').textContent = stage.description;
                document.getElementById('stageDap').textContent = stage.dap;
                
                document.getElementById('attentionPoints').style.display = 'block';
                document.getElementById('attentionList').innerHTML = stage.attention.map(a => `<li>${a}</li>`).join('');
            } else {
                document.getElementById('stageDisplay').classList.remove('active');
                document.getElementById('attentionPoints').style.display = 'none';
            }
            saveToLocalStorage();
        }

        function calculateDAP() {
            const plantio = document.getElementById('plantio').value;
            const visita = document.getElementById('data').value;
            if (plantio && visita) {
                const p = new Date(plantio);
                const v = new Date(visita);
                const dap = Math.floor((v - p) / (1000 * 60 * 60 * 24));
                document.getElementById('dapValue').textContent = dap;
                document.getElementById('dapInfo').style.display = 'block';
            }
            saveToLocalStorage();
        }

        function getCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const lat = position.coords.latitude.toFixed(6);
                        const lng = position.coords.longitude.toFixed(6);
                        document.getElementById('coordenadas').value = `${lat}, ${lng}`;
                        saveToLocalStorage();
                    },
                    function(error) {
                        alert('Erro ao obter localiza√ß√£o: ' + error.message);
                    }
                );
            }
        }

        // PDF Settings
        function setPhotoQuality(quality, btn) {
            pdfPhotoQuality = quality;
            btn.parentElement.querySelectorAll('.photo-size-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            updateEstimatedSize();
            saveToLocalStorage();
        }

        function setPhotosPerPage(count, btn) {
            pdfPhotosPerPage = count;
            btn.parentElement.querySelectorAll('.photo-size-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            updateEstimatedSize();
            saveToLocalStorage();
        }

        function updateEstimatedSize() {
            const qualityMultipliers = { 'baixa': 0.3, 'media': 0.7, 'alta': 1.0 };
            const baseSize = 0.5;
            const photoSize = photos.length * 0.8 * qualityMultipliers[pdfPhotoQuality];
            const totalSize = baseSize + photoSize;
            document.getElementById('estimatedSize').textContent = `~${totalSize.toFixed(1)} MB`;
        }

        // LocalStorage
        function saveToLocalStorage() {
            const data = {
                produtor: document.getElementById('produtor').value,
                propriedade: document.getElementById('propriedade').value,
                data: document.getElementById('data').value,
                area: document.getElementById('area').value,
                cultivar: document.getElementById('cultivar').value,
                plantio: document.getElementById('plantio').value,
                stageSelect: document.getElementById('stageSelect').value,
                observacoes: document.getElementById('observacoes').value,
                recomendacoes: document.getElementById('recomendacoes').value,
                tecnico: document.getElementById('tecnico').value,
                coordenadas: document.getElementById('coordenadas').value,
                tipo: document.querySelector('input[name="tipo"]:checked')?.value,
                amostraSolo: document.getElementById('amostraSolo').checked,
                selectedCategories: Array.from(selectedCategories),
                activePhotoCategory,
                severityData,
                categoryNotes,
                selectedNutrients: Array.from(selectedNutrients),
                photos,
                pdfPhotoQuality,
                pdfPhotosPerPage
            };
            localStorage.setItem('relatorioVisitaV2', JSON.stringify(data));
            showSaveIndicator();
        }

        function loadFromLocalStorage() {
            const saved = localStorage.getItem('relatorioVisitaV2');
            if (!saved) return;

            try {
                const data = JSON.parse(saved);
                
                document.getElementById('produtor').value = data.produtor || '';
                document.getElementById('propriedade').value = data.propriedade || '';
                document.getElementById('data').value = data.data || '';
                document.getElementById('area').value = data.area || '';
                document.getElementById('cultivar').value = data.cultivar || '';
                document.getElementById('plantio').value = data.plantio || '';
                document.getElementById('stageSelect').value = data.stageSelect || '';
                document.getElementById('observacoes').value = data.observacoes || '';
                document.getElementById('recomendacoes').value = data.recomendacoes || '';
                document.getElementById('tecnico').value = data.tecnico || '';
                document.getElementById('coordenadas').value = data.coordenadas || '';
                
                if (data.tipo) {
                    document.querySelector(`input[name="tipo"][value="${data.tipo}"]`).checked = true;
                }
                document.getElementById('amostraSolo').checked = data.amostraSolo || false;
                
                selectedCategories = new Set(data.selectedCategories || []);
                activePhotoCategory = data.activePhotoCategory || null;
                severityData = data.severityData || {};
                categoryNotes = data.categoryNotes || {};
                selectedNutrients = new Set(data.selectedNutrients || []);
                photos = data.photos || [];
                pdfPhotoQuality = data.pdfPhotoQuality || 'media';
                pdfPhotosPerPage = data.pdfPhotosPerPage || 1;
                
                // Update UI
                calculateDAP();
                showStageInfo();
                
                selectedCategories.forEach(id => {
                    const item = document.querySelector(`[data-category="${id}"]`);
                    if (item) item.classList.add('selected');
                });
                
                renderProblems();
                renderFullPhotos();
                updateFloatingButton();
                
            } catch (err) {
                console.error('Error loading:', err);
            }
        }

        function clearLocalStorage() {
            if (confirm('Limpar todos os dados?')) {
                localStorage.removeItem('relatorioVisitaV2');
                location.reload();
            }
        }

        function showSaveIndicator() {
            const indicator = document.getElementById('saveIndicator');
            indicator.classList.add('show');
            setTimeout(() => indicator.classList.remove('show'), 1500);
        }

        // PDF Export
        async function exportToPDF() {
            try {
                const loadingDiv = document.createElement('div');
                loadingDiv.style.cssText = `
                    position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                    background: rgba(0, 0, 0, 0.9); color: white; padding: 30px 50px;
                    border-radius: 12px; z-index: 10000; font-size: 1.2em; text-align: center;
                `;
                loadingDiv.innerHTML = 'üìÑ Gerando PDF...';
                document.body.appendChild(loadingDiv);

                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();
                const margin = 15;
                const contentWidth = pageWidth - (2 * margin);
                let yPosition = margin;

                function checkNewPage(requiredSpace) {
                    if (yPosition + requiredSpace > pageHeight - margin) {
                        pdf.addPage();
                        yPosition = margin;
                        return true;
                    }
                    return false;
                }

                // Header
                pdf.setFillColor(28, 28, 30);
                pdf.rect(0, 0, pageWidth, 25, 'F');
                pdf.setTextColor(255, 255, 255);
                pdf.setFontSize(18);
                pdf.setFont(undefined, 'bold');
                pdf.text('Relat√≥rio de Visita Agr√≠cola', pageWidth / 2, 15, { align: 'center' });
                yPosition = 35;

                // Get data
                const produtor = document.getElementById('produtor').value || 'N√£o informado';
                const propriedade = document.getElementById('propriedade').value || 'N√£o informado';
                const data = document.getElementById('data').value || 'N√£o informado';
                const area = document.getElementById('area').value || 'N√£o informado';
                const cultivar = document.getElementById('cultivar').value || 'N√£o informado';
                const plantio = document.getElementById('plantio').value || 'N√£o informado';
                const dapValue = document.getElementById('dapValue').textContent || '0';
                const stageSelect = document.getElementById('stageSelect');
                const selectedStage = stageSelect.options[stageSelect.selectedIndex].text || 'N√£o informado';
                const observacoes = document.getElementById('observacoes').value || 'Nenhuma';
                const recomendacoes = document.getElementById('recomendacoes').value || 'Nenhuma';
                const tecnico = document.getElementById('tecnico').value || 'N√£o informado';
                const coordenadas = document.getElementById('coordenadas').value || 'N√£o informado';

                // Section: Informa√ß√µes
                pdf.setTextColor(0, 0, 0);
                pdf.setFontSize(14);
                pdf.setFont(undefined, 'bold');
                pdf.text('INFORMA√á√ïES DA VISITA', margin, yPosition);
                yPosition += 8;

                pdf.setFontSize(10);
                pdf.setFont(undefined, 'normal');
                [
                    `Produtor: ${produtor}`,
                    `Propriedade: ${propriedade}`,
                    `Data: ${data}`,
                    `√Årea: ${area} ha`,
                    `Cultivar: ${cultivar}`,
                    `Plantio: ${plantio}`,
                    `DAP: ${dapValue} dias`,
                    `Est√°dio: ${selectedStage}`
                ].forEach(line => {
                    checkNewPage(7);
                    pdf.text(line, margin, yPosition);
                    yPosition += 6;
                });

                yPosition += 5;

                // Problems
                if (selectedCategories.size > 0) {
                    checkNewPage(20);
                    pdf.setFontSize(14);
                    pdf.setFont(undefined, 'bold');
                    pdf.text('PROBLEMAS IDENTIFICADOS', margin, yPosition);
                    yPosition += 8;

                    Array.from(selectedCategories).forEach(catId => {
                        checkNewPage(15);
                        const cat = categories[catId];
                        pdf.setFontSize(11);
                        pdf.setFont(undefined, 'bold');
                        pdf.text(`${cat.title}`, margin, yPosition);
                        yPosition += 6;

                        pdf.setFontSize(10);
                        pdf.setFont(undefined, 'normal');

                        if (cat.type === 'multi' && severityData[catId]) {
                            cat.levels.forEach(level => {
                                if (severityData[catId][level.id]) {
                                    checkNewPage(6);
                                    pdf.text(`  ${level.name}: ${severityData[catId][level.id]}`, margin + 2, yPosition);
                                    yPosition += 5;
                                }
                            });
                        } else if (cat.type === 'nutrients' && selectedNutrients.size > 0) {
                            const nutrientsList = Array.from(selectedNutrients).join(', ');
                            checkNewPage(6);
                            pdf.text(`  Deficientes: ${nutrientsList}`, margin + 2, yPosition);
                            yPosition += 5;
                        } else if (severityData[catId]?.main) {
                            checkNewPage(6);
                            pdf.text(`  N√≠vel: ${severityData[catId].main}`, margin + 2, yPosition);
                            yPosition += 5;
                        }

                        // Category photos count
                        const catPhotos = photos.filter(p => p.category === catId).length;
                        if (catPhotos > 0) {
                            pdf.text(`  Fotos: ${catPhotos}`, margin + 2, yPosition);
                            yPosition += 5;
                        }

                        // Category notes
                        if (categoryNotes[catId]) {
                            yPosition += 2;
                            pdf.setFont(undefined, 'italic');
                            const noteLines = pdf.splitTextToSize(`  Obs: ${categoryNotes[catId]}`, contentWidth - 10);
                            noteLines.forEach(line => {
                                checkNewPage(5);
                                pdf.text(line, margin + 2, yPosition);
                                yPosition += 5;
                            });
                            pdf.setFont(undefined, 'normal');
                        }

                        yPosition += 3;
                    });
                }

                // Photos
                if (photos.length > 0) {
                    checkNewPage(20);
                    pdf.setFontSize(14);
                    pdf.setFont(undefined, 'bold');
                    pdf.text('FOTOS', margin, yPosition);
                    yPosition += 8;

                    const qualitySettings = {
                        'baixa': { compression: 0.4, baseHeight: 50 },
                        'media': { compression: 0.7, baseHeight: 70 },
                        'alta': { compression: 0.92, baseHeight: 90 }
                    };
                    const settings = qualitySettings[pdfPhotoQuality];

                    for (let i = 0; i < photos.length; i++) {
                        const photo = photos[i];
                        const photoSizeMultiplier = (photo.size || 100) / 100;
                        const imgHeight = settings.baseHeight * photoSizeMultiplier;
                        
                        checkNewPage(imgHeight + 15);

                        pdf.setFontSize(10);
                        pdf.setFont(undefined, 'bold');
                        pdf.text(`${photo.categoryName}`, margin, yPosition);
                        yPosition += 5;

                        try {
                            pdf.addImage(photo.data, 'JPEG', margin, yPosition, contentWidth, imgHeight, undefined, 'FAST');
                            yPosition += imgHeight + 10;
                        } catch (err) {
                            pdf.setFont(undefined, 'normal');
                            pdf.text('[Erro ao adicionar imagem]', margin, yPosition);
                            yPosition += 10;
                        }
                    }
                }

                // Observa√ß√µes
                checkNewPage(30);
                pdf.setFontSize(14);
                pdf.setFont(undefined, 'bold');
                pdf.text('OBSERVA√á√ïES', margin, yPosition);
                yPosition += 8;

                pdf.setFontSize(10);
                pdf.setFont(undefined, 'normal');
                pdf.splitTextToSize(observacoes, contentWidth).forEach(line => {
                    checkNewPage(6);
                    pdf.text(line, margin, yPosition);
                    yPosition += 5;
                });

                yPosition += 5;

                // Recomenda√ß√µes
                checkNewPage(30);
                pdf.setFontSize(14);
                pdf.setFont(undefined, 'bold');
                pdf.text('RECOMENDA√á√ïES', margin, yPosition);
                yPosition += 8;

                pdf.setFontSize(10);
                pdf.setFont(undefined, 'normal');
                pdf.splitTextToSize(recomendacoes, contentWidth).forEach(line => {
                    checkNewPage(6);
                    pdf.text(line, margin, yPosition);
                    yPosition += 5;
                });

                yPosition += 10;

                // Info adicional
                checkNewPage(30);
                pdf.setFontSize(14);
                pdf.setFont(undefined, 'bold');
                pdf.text('INFORMA√á√ïES ADICIONAIS', margin, yPosition);
                yPosition += 8;

                pdf.setFontSize(10);
                pdf.setFont(undefined, 'normal');
                [`T√©cnico: ${tecnico}`, `Coordenadas: ${coordenadas}`].forEach(line => {
                    checkNewPage(6);
                    pdf.text(line, margin, yPosition);
                    yPosition += 6;
                });

                // Footer
                pdf.setFontSize(8);
                pdf.setTextColor(128, 128, 128);
                pdf.text(`Gerado em: ${new Date().toLocaleString('pt-BR')}`, pageWidth / 2, pageHeight - 10, { align: 'center' });

                const fileName = `Relatorio_${propriedade.replace(/\s+/g, '_')}_${data}.pdf`;
                pdf.save(fileName);

                document.body.removeChild(loadingDiv);

                const successDiv = document.createElement('div');
                successDiv.style.cssText = `
                    position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                    background: rgba(52, 199, 89, 0.95); color: white; padding: 20px 40px;
                    border-radius: 12px; z-index: 10000;
                `;
                successDiv.textContent = '‚úì PDF gerado!';
                document.body.appendChild(successDiv);
                setTimeout(() => document.body.removeChild(successDiv), 2000);

            } catch (error) {
                console.error('PDF Error:', error);
                alert('Erro ao gerar PDF: ' + error.message);
            }
        }
    </script>
</body>
</html>
